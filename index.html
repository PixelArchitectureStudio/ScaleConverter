<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="canonical" href="https://pixelarchitecturestudio.github.io/ScaleConverter/">
  <meta name="description" content="ابزار تبدیل مقیاس
تبدیل واحدهای دنیای واقعی (۱:۱) به واحدهای نقشه در مقیاس ۱:N — با مقیاس‌های آماده و گزینهٔ «مقیاس دلخواه»، پشتیبانی از واحدهای متریک و ایمپریال.">
  
  
  <link rel="icon" href="Last%20icon.svg" type="image/svg+xml">
  
  <link rel="icon" href="favicon.ico" sizes="any">
  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
  <link rel="icon" href="favicon-32.png" sizes="32x32" type="image/png">
  <link rel="icon" href="favicon-16.png" sizes="16x16" type="image/png">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="167x167" href="apple-touch-icon-167.png">
  <link rel="apple-touch-icon" sizes="152x152" href="apple-touch-icon-152.png">
  <link rel="apple-touch-icon" sizes="120x120" href="apple-touch-icon-120.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Scale Converter">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#0f1320">
  <meta name="application-name" content="ابزار تبدیل مقیاس">
  <meta name="color-scheme" content="light dark">
  
  
  <meta property="og:type" content="website">
  <meta property="og:locale" content="fa_IR">
  <meta property="og:title" content="Scale Converter • Pixel Studio">
  <meta property="og:description" content="ابزار تبدیل مقیاس
تبدیل واحدهای دنیای واقعی (۱:۱) به واحدهای نقشه در مقیاس ۱:N — با مقیاس‌های آماده و گزینهٔ «مقیاس دلخواه»، پشتیبانی از واحدهای متریک و ایمپریال.">
  
  <meta property="og:url" content="https://pixelarchitecturestudio.github.io/ScaleConverter/">
  <meta property="og:site_name" content="Scale Converter • Pixel Studio">
  <meta property="og:image" content="https://pixelarchitecturestudio.github.io/ScaleConverter/apple-touch-icon.png?v=2">
  <meta property="og:image:secure_url" content="https://pixelarchitecturestudio.github.io/ScaleConverter/apple-touch-icon.png?v=2">
  <meta property="og:image:type" content="image/png">
  <meta property="og:image:width" content="180">
  <meta property="og:image:height" content="180">
  <meta property="og:updated_time" content="2025-10-03T00:00:00Z">
  <link rel="image_src" href="https://pixelarchitecturestudio.github.io/ScaleConverter/apple-touch-icon.png?v=2">

  
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Scale Converter • Pixel Studio">
  <meta name="twitter:description" content="ابزار تبدیل مقیاس
تبدیل واحدهای دنیای واقعی (۱:۱) به واحدهای نقشه در مقیاس ۱:N — با مقیاس‌های آماده و گزینهٔ «مقیاس دلخواه»، پشتیبانی از واحدهای متریک و ایمپریال.">
  <meta name="twitter:image" content="https://pixelarchitecturestudio.github.io/ScaleConverter/apple-touch-icon.png?v=2">
  
  <meta name="twitter:site" content="@pixel_architecture_studio">
  <title>Scale Converter</title>
  <style>
    :root { --bg:#0f1320; --card:#161a2b; --muted:#8ea0b9; --text:#eef3ff; --accent:#7aa2ff; }
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(1200px 800px at 20% -10%, #1b2140 0%, var(--bg) 60%), var(--bg);min-height:100vh;font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; color:var(--text);overflow-x:hidden;overflow-y:hidden;}
    .wrap{max-width:860px;margin:56px auto 48px;padding:24px}
    h1{font-size:22px;margin:0 0 16px}
    p.desc{margin:0 0 22px;color:var(--muted)}
    .card{background:linear-gradient(180deg, #1a1f36, #121629);border:1px solid #2a2f47; padding:18px;border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
    label{display:block;font-size:12px;color:#aab8d8;margin:0 0 6px}
    select,input{width:100%;padding:12px 12px;border-radius:12px;border:1px solid #2b3152;background:#0f1326;color:var(--text);outline:none}
    input[type="number"]::-webkit-outer-spin-button,input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0;}
    .grid{display:grid;gap:16px}
    .hint{font-size:12px;color:#94a3c7}
    .out{background:linear-gradient(180deg, #0f1428, #0b1022);padding:16px;border-radius:14px;border:1px dashed #2f365e;position:relative}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .big{font-size:28px; font-weight:700}
    .copy{cursor:pointer;border:1px solid #2b3152;background:#0f1326;color:#cdd7ff;border-radius:10px;padding:8px 10px}
    .flex{display:flex; align-items:center; gap:12px; flex-wrap:wrap}
    .hstack{display:flex; align-items:center; gap:8px}
    .toggle-inline{display:inline-flex; align-items:center; gap:0; white-space:nowrap}
    .toggle-inline .hint{margin:0; line-height:1; padding:0; transform: translateX(-4px);} 
    .toggle-inline input[type="checkbox"]{margin:0; padding:0; width:16px; height:16px; vertical-align:middle;}
    .footer{margin-top:16px; color:#90a4d4; font-size:12px}
    .ig-link{display:inline-flex;align-items:center;gap:6px;margin-inline-start:8px;color:#cdd7ff;text-decoration:none;border:1px solid #2b3152;padding:4px 8px;border-radius:8px}
    .ig-link:hover{border-color:#7aa2ff}
    .ig{width:14px;height:14px}
    .handle{display:inline-flex; flex-direction:row; align-items:center; gap:0; direction:ltr; white-space:nowrap; line-height:1}
    .handle .at{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; display:inline}
    .swap{position:relative}
    .swap > *{width:100%}
    .swap.manual #scaleSelect{display:none}
    .swap.manual #scaleN{display:block}
    .swap:not(.manual) #scaleSelect{display:block}
    .swap:not(.manual) #scaleN{display:none}

    
    .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .actions{display:flex;align-items:center;gap:10px}
    .icon-btn{width:32px;height:32px;display:inline-flex;align-items:center;justify-content:center;border-radius:10px;padding:0;font-size:16px}
    .lang-btn{min-width:60px;position:relative;cursor:pointer;border:1px solid #2b3152;background:#0f1326;color:var(--text);border-radius:999px;display:inline-flex;align-items:center;justify-content:center;height:28px;padding:0 14px;font-size:12px;font-weight:600;letter-spacing:.04em;text-transform:uppercase}
    .lang-btn:hover{filter:brightness(1.1)}
    .lang-btn .lang-text{pointer-events:none}
    .switch{position:relative;cursor:pointer;border:1px solid #2b3152;background:#0f1326;color:var(--text);border-radius:999px;display:inline-flex;align-items:center;justify-content:center;width:54px;height:28px;padding:0}
    .switch span{pointer-events:none}
    .switch .thumb{position:absolute;top:2px;left:2px;width:24px;height:24px;border-radius:999px;background:var(--accent);box-shadow:0 2px 6px rgba(0,0,0,.35);transition:transform .25s ease}
    .switch .icon{position:absolute;top:50%;transform:translateY(-50%);font-size:12px;opacity:.9}
    .switch .icon.sun{left:8px}
    .switch .icon.moon{right:8px}
    .switch[data-mode="light"] .thumb{transform:translateX(26px)}

    
    body.light{background:linear-gradient(180deg,#ffffff,#f6f8ff);color:#0d1220}
    body.light .card{background:#ffffff;border-color:#e2e8f0;box-shadow:0 10px 30px rgba(0,0,0,.06)}
    body.light label{color:#56617a}
    body.light select, body.light input{background:#ffffff;border-color:#cbd5e1;color:#0d1220}
    body.light .out{background:#f4f6fb;border-color:#d0d8e6}
    body.light .copy{background:#ffffff;border-color:#cbd5e1;color:#0d1220}
    body.light .hint{color:#64748b}
    body.light .footer{color:#5f6b88}
    body.light .ig-link{color:#334155;border-color:#cbd5e1}
    body.light .ig-link:hover{border-color:#3b82f6}
    body.light .switch{background:#ffffff;border-color:#cbd5e1;color:#0d1220}
    body.light .lang-btn{background:#ffffff;border-color:#cbd5e1;color:#0d1220}

    
    .hist-pop{position:absolute; right:12px; top:100%; margin-top:8px; background:#0f1326; border:1px solid #2b3152; border-radius:12px; width:260px; padding:10px; box-shadow:0 10px 30px rgba(0,0,0,.35); z-index:70}
    .hist-pop.hidden{display:none}
    .hist-head{font-size:12px; color:#94a3c7; margin:0 0 6px}
    .hist-list{list-style:none; padding:0; margin:0; max-height:220px; overflow:auto}
    .hist-list li{font-size:13px; padding:6px 0; border-bottom:1px dashed #2f365e}
    .hist-list li:last-child{border-bottom:none}
    .hist-empty{font-size:12px; color:#94a3c7}
    body.light .hist-pop{background:#ffffff; border-color:#cbd5e1; box-shadow:0 10px 30px rgba(0,0,0,.12)}

    .hstack.toggle-inline{gap:0 !important;}
    .ltr{direction:ltr;text-align:left}
      
    #calcBtn{background:#7aa2ff;border-color:#7aa2ff;color:#0b1022;width:100%;padding:12px 14px;font-weight:600;font-family:inherit}
    #calcBtn:hover{filter:brightness(.95)}
    #calcBtn:active{transform:translateY(1px)}
    body.light #calcBtn{background:#7aa2ff;border-color:#7aa2ff;color:#0b1022}
      
    select{
      -webkit-appearance:none; -moz-appearance:none; appearance:none;
      background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M7 10l5 5 5-5' fill='%23ffffff'/></svg>");
      background-repeat:no-repeat;
      background-position:12px center;
      background-size:14px 14px;

      text-align:right;
      text-align-last:right;
      direction:rtl;

      padding-left:36px;
      padding-right:12px;
    }

    body.light select{

      -webkit-appearance:none; -moz-appearance:none; appearance:none;
      background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M7 10l5 5 5-5' fill='%230d1220'/></svg>");
      background-repeat:no-repeat;
      background-position:12px center;
      background-size:14px 14px;
      padding-left:36px;
      text-align:right; text-align-last:right; direction:rtl;
    }

    select::-ms-expand{display:none}

    select option{direction:rtl; text-align:right;}

    body.lang-en select{
      direction:ltr;
      text-align:left;
      text-align-last:left;
      padding-right:36px;
      padding-left:12px;
      background-position:calc(100% - 12px) center;
    }

    body.light.lang-en select{background-position:calc(100% - 12px) center;}

    body.lang-en select option{direction:ltr; text-align:left;}
      
    .footer-bar{display:flex;align-items:center;justify-content:space-between;position:relative}
    .version{color:#90a4d4;font-size:12px;border:1px solid #2b3152;border-radius:10px;padding:4px 10px;background:#0f1326;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;line-height:1;gap:6px;min-height:28px;font-family:inherit;font-weight:600}
    body.light .version{color:#0d1220;border-color:#cbd5e1;background:#ffffff}
      
    .ver-pop{position:absolute; left:12px; bottom:calc(100% + 8px); background:#0f1326; border:1px solid #2b3152; border-radius:12px; width:280px; padding:12px; box-shadow:0 10px 30px rgba(0,0,0,.35); z-index:90}
    .ver-pop.hidden{display:none}
    .ver-title{font-weight:700; margin-bottom:6px}
    .ver-hint{font-size:12px; color:#94a3c7; margin-top:6px}
    body.light .ver-pop{background:#ffffff; border-color:#cbd5e1; box-shadow:0 10px 30px rgba(0,0,0,.12)}
      
    html, body{height:100%}
    body{min-height:100svh;height:100dvh;overflow-x:hidden;overflow-y:hidden}
    @supports (height: 100dvh){ body{height:100dvh} }
      
    @media (max-width: 520px) and (orientation: portrait){
      .wrap{max-width:100%; margin:28px auto 24px; padding:16px 18px; padding-left:max(18px, env(safe-area-inset-left, 0px)); padding-right:max(18px, env(safe-area-inset-right, 0px));}

      .row-3{grid-template-columns: minmax(0,1fr) minmax(120px,0.7fr) minmax(0,1fr); gap:10px}
      label{font-size:11.5px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

      select, input{min-height:40px; font-size:14px}
      select{background-position:8px center; background-size:12px 12px; padding-left:28px; padding-right:10px; text-overflow:ellipsis}
      body.light select{background-position:8px center; background-size:12px 12px; padding-left:28px}
      body.lang-en label{white-space:normal; text-overflow:unset}
      body.lang-en select{background-position:calc(100% - 8px) center; padding-right:28px; padding-left:10px; text-overflow:ellipsis}
      body.light.lang-en select{background-position:calc(100% - 8px) center}

      .row-3 > div:nth-child(2) .grid{gap:6px !important}
      #scaleSelect, #scaleN{font-size:14px}
    }

    @media (max-width: 430px){
      .wrap{margin:22px auto 18px; padding:16px 14px; gap:16px}
      .card{padding:16px}
      .topbar{flex-wrap:wrap; gap:8px}
      .topbar h1{font-size:20px}
      .actions{gap:8px}
      .row{grid-template-columns:minmax(0,1fr) minmax(0,1fr); gap:10px}
      .row-3{grid-template-columns:minmax(0,1fr) minmax(0,0.85fr) minmax(0,1fr); gap:10px}
      .row-3 > div:nth-child(2) .grid{gap:6px !important}
      label{font-size:11px}
      select,input{padding:10px; font-size:13px}
      select{background-position:8px center; background-size:12px 12px; padding-left:26px}
      body.light select{background-position:8px center; background-size:12px 12px; padding-left:26px}
      body.lang-en select{background-position:calc(100% - 8px) center; padding-right:26px; padding-left:10px}
      body.light.lang-en select{background-position:calc(100% - 8px) center}
      .footer-bar{gap:8px}
      .footer-left{gap:4px}
      .footer-right{gap:6px}
      #dlBtn, #versionBtn{min-width:0}
    }

    @media (max-width: 360px){
      .wrap{margin:28px auto 16px; padding:14px 12px}
      .card{padding:14px}
      .topbar{gap:6px}
      .topbar h1{font-size:18px}
      h1{font-size:18px}
      p.desc{font-size:13px; line-height:1.5}
      .actions{gap:6px}
      .lang-btn{height:26px; min-width:54px; padding:0 12px; font-size:11px}
      .switch{width:48px; height:26px}
      .switch .thumb{width:22px; height:22px}
      .switch[data-mode="light"] .thumb{transform:translateX(22px)}
      .switch .icon{font-size:11px}
      .switch .icon.sun{left:6px}
      .switch .icon.moon{right:6px}
      .row{gap:8px}
      .row-3{grid-template-columns:minmax(0,1fr) minmax(0,0.78fr) minmax(0,1fr); gap:8px}
      label{font-size:10.5px}
      select,input{padding:9px 9px; font-size:11.5px; border-radius:10px; min-height:36px}
      select{background-position:6px center; background-size:11px 11px; padding-left:24px}
      body.light select{background-position:6px center; background-size:11px 11px; padding-left:24px}
      #scaleSelect, #scaleN{font-size:11.5px}
      body.lang-en select, body.lang-en input{font-size:10.5px}
      body.lang-en #scaleSelect, body.lang-en #scaleN{font-size:10.5px}
      body.lang-en #downloadLabel{font-size:10px}
      body.lang-en select{background-position:calc(100% - 6px) center; padding-right:24px; padding-left:9px}
      body.light.lang-en select{background-position:calc(100% - 6px) center}
      .grid{gap:12px}
      .out{padding:14px; border-radius:12px}
      .big{font-size:24px}
      .copy{padding:6px 8px; font-size:12px}
      #calcBtn{padding:10px 12px; font-size:13px}
      .hint{font-size:11px}
      .footer{font-size:11px}
      .footer-bar{gap:6px}
      .footer-left{gap:4px}
      .footer-right{gap:6px}
      .version{min-height:26px; padding:4px 8px; font-size:11px}
      .ig-link{gap:4px; padding:4px 6px; font-size:11px}
      .ig-link .handle{font-size:11px}
      .ig-link .handle .mono.ltr{font-size:10px}
      .dl-pop{left:58%; transform:translateX(-48%); width:min(200px, calc(100vw - 28px));}
    }
      
    .footer-left{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
    @media (max-width: 520px) and (orientation: portrait){
      .footer-bar{align-items:flex-end}
    }
      
    .ver-section{margin-top:8px}
    .ver-section .label{font-weight:700;font-size:12px;color:#aab8d8;margin-bottom:4px}
    .ver-changes{font-size:12px;color:#c9d4f2}
    body.light .ver-section .label{color:#56617a}
    body.light .ver-changes{color:#334155}
      
    
      
    .hist-top{display:flex;align-items:center;justify-content:space-between;margin:0 0 6px}
    .hist-close{border:1px solid #2b3152;background:#0f1326;color:#cdd7ff;border-radius:8px;width:22px;height:22px;display:inline-flex;align-items:center;justify-content:center;cursor:pointer;line-height:1;font-size:14px}
    .hist-close:hover{filter:brightness(.95)}
    body.light .hist-close{background:#ffffff;border-color:#cbd5e1;color:#0d1220}
      
    @media (max-width:520px) and (orientation: portrait){
      .hist-pop{
        position:fixed; left:50%; top:50%; transform:translate(-50%,-50%);
        right:auto; bottom:auto; margin-top:0;
        width:min(360px, calc(100vw - 48px));
        max-height:60vh; overflow:auto; z-index:200;
      }
    }
      
    .footer-right{display:inline-flex;align-items:center;gap:8px}
    .dl-anchor{position:relative;display:inline-block}
    .dl-pop{position:absolute; left:56%; transform:translateX(-46%); bottom:calc(100% + 8px); background:#0f1326; border:1px solid #2b3152; border-radius:12px; width:min(220px, calc(100vw - 40px)); padding:8px; box-shadow:0 10px 30px rgba(0,0,0,.35); z-index:95}
    .dl-pop.hidden{display:none}
    .dl-item{display:flex; align-items:center; gap:8px; padding:8px; border-radius:8px; color:inherit; text-decoration:none}
    .dl-item:hover{background:#141a33}
    .dl-ic{width:16px;height:16px}
    .dl-emoji{font-size:16px;line-height:1}
    body.light .dl-pop{background:#ffffff; border-color:#cbd5e1; box-shadow:0 10px 30px rgba(0,0,0,.12)}
    body.light .dl-item:hover{background:#f1f5f9}
      
    
    #dlBtn .btn-ic{width:14px;height:14px}
      
    .ig-link.version{max-width:200px; padding:4px 8px; gap:6px}
    .ig-link.version .handle{min-width:0; overflow:hidden; text-overflow:ellipsis}
    @media (max-width:520px){ .ig-link.version{max-width:190px} }
      
    .ig-link.version .handle .mono.ltr{font-size:11px;}
    @media (max-width:520px){
      .ig-link.version .handle .mono.ltr, .ig-link.version .handle .at{font-size:9px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <h1 id="pageHeading" data-i18n-key="heading">ابزار تبدیل مقیاس</h1>
      <div class="actions">
        <button id="langToggle" class="lang-btn" type="button" aria-label="تغییر زبان به انگلیسی" data-lang="fa">
          <span class="lang-text" id="langToggleText">فا</span>
        </button>
        <button id="themeToggle" class="switch" aria-label="تغییر حالت روشن/تاریک" data-mode="dark">
          <span class="icon sun" aria-hidden="true">☀️</span>
          <span class="icon moon" aria-hidden="true">🌙</span>
          <span class="thumb" aria-hidden="true"></span>
        </button>
      </div>
    </div>
    <p class="desc" id="description" data-i18n-key="description" data-i18n-attr="innerHTML">واحد دنیای واقعی را انتخاب کنید (همیشه <strong>۱:۱</strong>)، سپس مقیاس هدف <strong>۱:N</strong> و واحد نقشه را برگزینید. مقدار واقعی را وارد کنید تا اندازه روی نقشه محاسبه شود.</p>

    <div class="card grid" role="form" aria-label="فرم مبدّل مقیاس" id="converterForm">
      <div class="row-3">
        <div>
          <label for="realUnit" id="realUnitLabel" data-i18n-key="realUnitLabel">واحد واقعی (۱:۱)</label>
          <select id="realUnit" aria-label="واحد واقعی">
            <option value="mm">میلی‌متر (mm)</option>
            <option value="cm">سانتی‌متر (cm)</option>
            <option value="m" selected>متر (m)</option>
            <option value="km">کیلومتر (km)</option>
            <option value="in">اینچ (in)</option>
            <option value="ft">فوت (ft)</option>
            <option value="yd">یارد (yd)</option>
            <option value="mi">مایل (mi)</option>
            <option value="nmi">مایل دریایی (nmi)</option>
          </select>
        </div>
        <div>
          <label for="scaleSelect" id="scaleSelectLabel" data-i18n-key="scaleSelectLabel">مقیاس هدف — ۱:N</label>
          <div class="grid" style="gap:8px">
            <div id="scaleSwap" class="swap">
              <select id="scaleSelect" aria-label="انتخاب مقیاس">
                <optgroup label="جزئیات (Detail)" data-i18n-group="scaleGroupDetail">
                  <option value="1">۱:۱</option>
                  <option value="2">۱:۲</option>
                  <option value="5">۱:۵</option>
                  <option value="10">۱:۱۰</option>
                </optgroup>
                <optgroup label="نقشه‌های معماری (Plans)" data-i18n-group="scaleGroupPlans">
                  <option value="20">۱:۲۰</option>
                  <option value="25">۱:۲۵</option>
                  <option value="50">۱:۵۰</option>
                  <option value="75">۱:۷۵</option>
                  <option value="100">۱:۱۰۰</option>
                  <option value="125">۱:۱۲۵</option>
                  <option value="150">۱:۱۵۰</option>
                  <option value="200" selected>۱:۲۰۰</option>
                  <option value="250">۱:۲۵۰</option>
                </optgroup>
                <optgroup label="سایت/شهر (Site/Urban)" data-i18n-group="scaleGroupSite">
                  <option value="400">۱:۴۰۰</option>
                  <option value="500">۱:۵۰۰</option>
                  <option value="1000">۱:۱۰۰۰</option>
                  <option value="2000">۱:۲۰۰۰</option>
                  <option value="5000">۱:۵۰۰۰</option>
                </optgroup>
              </select>
              <input id="scaleN" type="number" min="1" step="1" value="200" aria-label="عدد N مقیاس" class="ltr" />
            </div>
            <label class="hstack toggle-inline">
              <input type="checkbox" id="manualToggle" />
              <span class="hint" id="manualHint" data-i18n-key="manualHint">مقیاس دلخواه</span>
            </label>
          </div>
        </div>
        <div>
          <label for="targetUnit" id="targetUnitLabel" data-i18n-key="targetUnitLabel">واحد نقشه</label>
          <select id="targetUnit" aria-label="واحد نقشه">
            <option value="mm">میلی‌متر (mm)</option>
            <option value="cm" selected>سانتی‌متر (cm)</option>
            <option value="m">متر (m)</option>
            <option value="km">کیلومتر (km)</option>
            <option value="in">اینچ (in)</option>
            <option value="ft">فوت (ft)</option>
            <option value="yd">یارد (yd)</option>
            <option value="mi">مایل (mi)</option>
            <option value="nmi">مایل دریایی (nmi)</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="realValue"><span id="inputLabel">اندازه واقعی (فقط عدد)</span></label>
          <input id="realValue" type="text" inputmode="decimal" placeholder="مثلاً ۱۲٫۵ یا 12.5" aria-label="اندازه واقعی" class="ltr" dir="ltr" />
          <div class="hint" id="realHint">واحد: m</div>
          <div class="flex" style="margin-top:8px">
            <button type="button" class="copy" id="calcBtn" title="محاسبه" data-i18n-key="calcButton">محاسبه</button>
          </div>
        </div>
        <div>
          <label><span id="outputLabel">اندازهٔ روی نقشه (محاسبه‌شده)</span></label>
          <div class="out">
            <div class="big mono" id="outVal">—</div>
            <div class="hint" id="outUnit">واحد: cm</div>
            <div class="flex" style="margin-top:8px">
              <button type="button" class="copy" id="copyBtn" title="کپی مقدار" data-i18n-key="copyButton">کپی</button>
              <button type="button" class="copy" id="histBtn" title="تاریخچه ۱۰ مقدار اخیر">🕘</button>
              <button id="swapBtn" class="copy icon-btn" title="تبدیل جهت (نقشه ↔ واقعی)" aria-pressed="false">⇄</button>
              <span class="hint" id="copyNote"></span>
            </div>
            <div id="histPop" class="hist-pop hidden" role="dialog" aria-label="تاریخچه ۱۰ مقدار اخیر">
              <div class="hist-top">
                <div class="hist-head" id="histHead">تاریخچه (۱۰ مقدار اخیر)</div>
                <button type="button" id="histClose" class="hist-close" aria-label="بستن">×</button>
              </div>
              <ul id="histList" class="hist-list"></ul>
            </div>
          </div>
        </div>
      </div>

      <div class="grid">
        <div class="hint"><span id="detailHeading" data-i18n-key="detailHeading">جزئیات مبدل:</span> <span class="mono" id="detail">۱ (واحد واقعی) → ؟ (واحد نقشه) در مقیاس ۱:N</span></div>
        <div class="footer footer-bar">
          <div class="footer-left"><span id="footerCredit" data-i18n-key="footerCredit" data-i18n-attr="innerHTML">ساخته شده توسط <strong>Pixel Studio</strong></span>
            <a class="ig-link version" href="https://instagram.com/Pixel_architecture_studio" target="_blank" rel="noopener" aria-label="Instagram: @Pixel_architecture_studio">
              <svg class="ig" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <rect x="2" y="2" width="20" height="20" rx="5" ry="5" stroke="currentColor" stroke-width="1.5"></rect>
                <circle cx="12" cy="12" r="4" stroke="currentColor" stroke-width="1.5"></circle>
                <circle cx="17.5" cy="6.5" r="1.2" fill="currentColor"></circle>
              </svg>
              <span class="handle"><span class="at" aria-hidden="true">@</span><span class="mono ltr">pixel_architecture_studio</span></span>
            </a>
          </div>
          <span class="footer-right">
            <span class="dl-anchor">
              <button id="dlBtn" class="version" type="button" aria-haspopup="menu" aria-expanded="false" title="دانلود نرم‌افزار">
                <svg class="btn-ic" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 3a1 1 0 011 1v9.59l3.3-3.3a1 1 0 111.4 1.42l-5 5a1 1 0 01-1.4 0l-5-5a1 1 0 111.4-1.42L11 13.59V4a1 1 0 011-1zm-7 15a1 1 0 011-1h12a1 1 0 110 2H6a1 1 0 01-1-1z"/></svg>
                <span id="downloadLabel" data-i18n-key="downloadLabel">دانلود</span>
              </button>
              <div id="dlPop" class="dl-pop hidden" role="menu" aria-label="دانلود">
                <a href="https://github.com/PixelArchitectureStudio/ScaleConverter/releases/download/v1.4/ScaleConverter_Win64.exe" target="_blank" rel="noopener" id="dlWin" class="dl-item" role="menuitem">
                  <svg class="dl-ic" viewBox="0 0 24 24" aria-hidden="true">
                    <rect x="3" y="3" width="8" height="8" rx="1.6" ry="1.6" fill="currentColor"/>
                    <rect x="13" y="3" width="8" height="8" rx="1.6" ry="1.6" fill="currentColor"/>
                    <rect x="3" y="13" width="8" height="8" rx="1.6" ry="1.6" fill="currentColor"/>
                    <rect x="13" y="13" width="8" height="8" rx="1.6" ry="1.6" fill="currentColor"/>
                  </svg>
                  <span id="downloadWindows" data-i18n-key="downloadWindows">دانلود نسخه ویندوز</span>
                </a>
                <a href="https://pixelarchitecturestudio.github.io/ScaleConverter/" target="_blank" rel="noopener" id="dlWeb" class="dl-item" role="menuitem">
                  <svg class="dl-ic" viewBox="0 0 24 24" aria-hidden="true">
                    <rect x="7" y="2" width="10" height="20" rx="3" fill="none" stroke="currentColor" stroke-width="1.6"/>
                    <path d="M10 4.5h4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                    <path d="M9 19.5h6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                  </svg>
                  <span id="downloadWeb" data-i18n-key="downloadWeb">نسخه وب اپ</span>
                </a>
                <a href="https://www.zoomit.ir/mobile-learning/20984-how-to-add-website-links/" target="_blank" rel="noopener" id="dlWebHelp" class="dl-item" role="menuitem">
                  <svg class="dl-ic" viewBox="0 0 24 24" aria-hidden="true">
                    <circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="1.6"/>
                    <path d="M12 6a3 3 0 00-3 3h2a1 1 0 112 0c0 .5-.2.8-.7 1.1l-.6.4c-.9.6-1.2 1.3-1.2 2.5v.5h2v-.5c0-.6.1-.8.7-1.2l.6-.4A3 3 0 0015 9a3 3 0 00-3-3z" fill="currentColor"/>
                    <circle cx="12" cy="17" r="1" fill="currentColor"/>
                  </svg>
                  <span id="downloadWebHelp" data-i18n-key="downloadWebHelp">آموزش نصب نسخه وب اپ</span>
                </a>
              </div>
            </span>
            <button id="versionBtn" class="version mono ltr" type="button" aria-haspopup="dialog" aria-expanded="false" title="اطلاعات نسخه">v1.4</button>
          </span>
          <div id="verPop" class="ver-pop hidden" role="dialog" aria-label="اطلاعات نسخه">
            <div class="ver-title" id="versionTitle" data-i18n-key="versionTitle">نرم‌افزار تبدیل مقیاس</div>
            <div><span id="versionLabel" data-i18n-key="versionLabel">نسخه</span> <span class="mono ltr" id="versionText">1.4</span></div>
            <div class="ver-section">
              <div class="label" id="versionChangesLabel" data-i18n-key="versionChangesLabel">آخرین تغییرات</div>
              <div class="ver-changes" id="versionChanges" data-i18n-key="versionChanges">اصلاح رابط کاربری برای نمایش بهتر در حالت پرتره موبایل</div>
            </div>
            <div class="ver-hint" id="versionHint" data-i18n-key="versionHint">برای باخبر شدن از آخرین آپدیت‌ نرم افزار و پروژه‌های جدید نرم‌افزاری، پیج Pixel Studio رو فالو کنید.</div>
            <a class="ig-link version" href="https://instagram.com/Pixel_architecture_studio" target="_blank" rel="noopener" aria-label="Instagram: @Pixel_architecture_studio">
              <svg class="ig" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <rect x="2" y="2" width="20" height="20" rx="5" ry="5" stroke="currentColor" stroke-width="1.5"></rect>
                <circle cx="12" cy="12" r="4" stroke="currentColor" stroke-width="1.5"></circle>
                <circle cx="17.5" cy="6.5" r="1.2" fill="currentColor"></circle>
              </svg>
              <span class="handle"><span class="at" aria-hidden="true">@</span><span class="mono ltr">pixel_architecture_studio</span></span>
            </a>
          </div>
        </div>
      </div>
    </div>

    <div class="footer" id="footnote" style="margin-top:10px" data-i18n-key="footnote" data-i18n-attr="innerHTML">نکته: برای مقیاس‌دادن به هندسه در CAD از <span class="mono ltr">scale factor = 1 / N</span> استفاده کنید (مثلاً برای <span class="mono ltr">1:200</span>، ضریب <span class="mono ltr">0.005</span> است). این ابزار تبدیل واحدها را با همین مقیاس انجام می‌دهد.</div>
  </div>

  <script>
    const unitToMM = { mm:1, cm:10, m:1000, km:1000000, in:25.4, ft:304.8, yd:914.4, mi:1609344, nmi:1852000 };
    const APP_VERSION = '1.4';
    const el = (id) => document.getElementById(id);

    const realUnit = el('realUnit');
    const targetUnit = el('targetUnit');
    const scaleSelect = el('scaleSelect');
    const manualToggle = el('manualToggle');
    const scaleSwap = el('scaleSwap');
    const scaleN = el('scaleN');
    const realValue = el('realValue');
    const outVal = el('outVal');
    const outUnit = el('outUnit');
    const realHint = el('realHint');
    const detail = el('detail');
    const copyBtn = el('copyBtn');
    const copyNote = el('copyNote');
    const themeToggle = el('themeToggle');
    const swapBtn = el('swapBtn');
    const inputLabel = el('inputLabel');
    const outputLabel = el('outputLabel');
    const histBtn = el('histBtn');
    const histPop = el('histPop');
    const histList = el('histList');
    const histClose = el('histClose');
    const calcBtn = el('calcBtn');
    const versionBtn = el('versionBtn');
    const verPop = el('verPop');
    const versionText = el('versionText');
    const dlBtn = el('dlBtn');
    const dlPop = el('dlPop');
    const langToggle = el('langToggle');
    const langToggleText = el('langToggleText');
    const pageHeading = el('pageHeading');
    const descriptionEl = el('description');
    const realUnitLabel = el('realUnitLabel');
    const scaleSelectLabel = el('scaleSelectLabel');
    const targetUnitLabel = el('targetUnitLabel');
    const manualHint = el('manualHint');
    const histHead = el('histHead');
    const detailHeading = el('detailHeading');
    const footerCredit = el('footerCredit');
    const downloadLabel = el('downloadLabel');
    const downloadWindows = el('downloadWindows');
    const downloadWeb = el('downloadWeb');
    const downloadWebHelp = el('downloadWebHelp');
    const versionTitle = el('versionTitle');
    const versionLabel = el('versionLabel');
    const versionChangesLabel = el('versionChangesLabel');
    const versionChanges = el('versionChanges');
    const versionHint = el('versionHint');
    const footnote = el('footnote');
    const converterForm = el('converterForm');
    const bodyEl = document.body;

    const selectElements = Array.from(document.querySelectorAll('select'));
    const SCROLL_UNLOCK_BREAKPOINT = 520;
    let scrollLockFrame = null;

    function needsBodyScroll(){
      if (!bodyEl) return false;
      if (window.innerWidth > SCROLL_UNLOCK_BREAKPOINT) return false;
      const docEl = document.documentElement;
      const totalHeight = Math.max(bodyEl.scrollHeight, docEl ? docEl.scrollHeight : 0);
      const viewportHeight = window.innerHeight || (docEl ? docEl.clientHeight : 0);
      return totalHeight > (viewportHeight + 1);
    }

    function updateBodyScrollLock(){
      if (!bodyEl) return;
      if (needsBodyScroll()){
        if (!bodyEl.classList.contains('scroll-unlocked')){
          bodyEl.style.overflowY = 'auto';
          bodyEl.classList.add('scroll-unlocked');
        }
      } else if (bodyEl.classList.contains('scroll-unlocked')){
        bodyEl.style.removeProperty('overflow-y');
        bodyEl.classList.remove('scroll-unlocked');
      }
    }

    function scheduleBodyScrollLockUpdate(){
      if (scrollLockFrame) cancelAnimationFrame(scrollLockFrame);
      scrollLockFrame = requestAnimationFrame(() => {
        scrollLockFrame = null;
        updateBodyScrollLock();
      });
    }

    const relockAfterInteraction = () => setTimeout(updateBodyScrollLock, 150);

    selectElements.forEach((selectEl) => {
      selectEl.addEventListener('focus', updateBodyScrollLock);
      selectEl.addEventListener('blur', relockAfterInteraction);
      selectEl.addEventListener('change', relockAfterInteraction);
    });

    window.addEventListener('resize', scheduleBodyScrollLockUpdate);
    window.addEventListener('orientationchange', scheduleBodyScrollLockUpdate);
    window.addEventListener('load', updateBodyScrollLock);
    window.addEventListener('pagehide', () => {
      if (!bodyEl) return;
      bodyEl.style.removeProperty('overflow-y');
      bodyEl.classList.remove('scroll-unlocked');
    });

    updateBodyScrollLock();
    const locales = {
      fa: {
        code: 'fa',
        langButton: 'فا',
        langToggleLabel: 'تغییر زبان به انگلیسی',
        htmlLang: 'fa',
        dir: 'rtl',
        themeToggleLabel: 'تغییر حالت روشن/تاریک',
        pageTitle: 'ابزار تبدیل مقیاس',
        heading: 'ابزار تبدیل مقیاس',
        description: 'واحد دنیای واقعی را انتخاب کنید (همیشه <strong>۱:۱</strong>)، سپس مقیاس هدف <strong>۱:N</strong> و واحد نقشه را برگزینید. مقدار واقعی را وارد کنید تا اندازه روی نقشه محاسبه شود.',
        realUnitLabel: 'واحد واقعی (۱:۱)',
        scaleSelectLabel: 'مقیاس هدف — ۱:N',
        targetUnitLabel: 'واحد نقشه',
        manualHint: 'مقیاس دلخواه',
        calcButton: 'محاسبه',
        calcButtonTitle: 'محاسبه',
        copyButton: 'کپی',
        copyButtonTitle: 'کپی مقدار',
        histButtonTitle: 'تاریخچه ۱۰ مقدار اخیر',
        swapButtonTitle: 'تبدیل جهت (نقشه ↔ واقعی)',
        detailHeading: 'جزئیات مبدل:',
        footerCredit: 'ساخته شده توسط <strong>Pixel Studio</strong>',
        downloadLabel: 'دانلود',
        downloadTitle: 'دانلود نرم‌افزار',
        downloadAria: 'دانلود',
        downloadWindows: 'دانلود نسخه ویندوز',
        downloadWeb: 'نسخه وب اپ',
        downloadWebHelp: 'آموزش نصب نسخه وب اپ',
        versionTitle: 'نرم‌افزار تبدیل مقیاس',
        versionLabel: 'نسخه',
        versionChangesLabel: 'آخرین تغییرات',
        versionChanges: 'اصلاح رابط کاربری برای نمایش بهتر در حالت پرتره موبایل',
        versionHint: 'برای باخبر شدن از آخرین آپدیت‌ نرم افزار و پروژه‌های جدید نرم‌افزاری، پیج Pixel Studio رو فالو کنید.',
        footnote: 'نکته: برای مقیاس‌دادن به هندسه در CAD از <span class="mono ltr">scale factor = 1 / N</span> استفاده کنید (مثلاً برای <span class="mono ltr">1:200</span>، ضریب <span class="mono ltr">0.005</span> است). این ابزار تبدیل واحدها را با همین مقیاس انجام می‌دهد.',
        histDialogLabel: 'تاریخچه ۱۰ مقدار اخیر',
        histTitle: 'تاریخچه (۱۰ مقدار اخیر)',
        histCloseLabel: 'بستن',
        histEmpty: 'خالی',
        copyPrompt: 'ابتدا مقدار را محاسبه کنید',
        copySuccess: 'کپی شد!',
        copyFail: 'کپی ناموفق',
        unitsLabel: (unit) => `واحد: ${unit}`,
        detailIdle: (from, to, n) => `۱ ${from} → ؟ ${to} در مقیاس ۱:${n}`,
        detailForward: (rU, tU, ratio, nLabel) => `۱ ${rU} = ${ratio} ${tU}  (مقیاس ۱:${nLabel})`,
        detailReverse: (tU, rU, ratio, nLabel) => `۱ ${tU} = ${ratio} ${rU}  (مقیاس ۱:${nLabel})`,
        historyInfo: (rvStr, scaleStr) => `اندازه واقعی: ${rvStr} | مقیاس ${scaleStr}`,
        scaleLabel: (nLabel) => `۱:${nLabel}`,
        scaleUnknown: '۱:N',
        inputLabelNormal: 'اندازه واقعی (فقط عدد)',
        outputLabelNormal: 'اندازهٔ روی نقشه (محاسبه‌شده)',
        inputLabelReverse: 'اندازه روی نقشه (ورودی)',
        outputLabelReverse: 'اندازه واقعی (محاسبه‌شده)',
        versionBtnTitle: 'اطلاعات نسخه',
        realValuePlaceholder: 'مثلاً ۱۲٫۵ یا 12.5',
        realValueAria: 'اندازه واقعی',
        realUnitAria: 'واحد واقعی',
        targetUnitAria: 'واحد نقشه',
        scaleSelectAria: 'انتخاب مقیاس',
        scaleNAria: 'عدد N مقیاس',
        formAriaLabel: 'فرم مبدّل مقیاس'
      },
      en: {
        code: 'en',
        langButton: 'EN',
        langToggleLabel: 'Switch language to Persian',
        htmlLang: 'en',
        dir: 'rtl',
        themeToggleLabel: 'Toggle light/dark mode',
        pageTitle: 'Scale Converter',
        heading: 'Scale Converter',
        description: 'Select the real-world unit (always <strong>1:1</strong>), then choose the target scale <strong>1:N</strong> and map unit. Enter the real measurement to compute the map size.',
        realUnitLabel: 'Real-world unit (1:1)',
        scaleSelectLabel: 'Target scale — 1:N',
        targetUnitLabel: 'Map unit',
        manualHint: 'Custom scale',
        calcButton: 'Calculate',
        calcButtonTitle: 'Calculate',
        copyButton: 'Copy',
        copyButtonTitle: 'Copy value',
        histButtonTitle: 'History (last 10 values)',
        swapButtonTitle: 'Swap direction (map ↔ real)',
        detailHeading: 'Converter details:',
        footerCredit: 'Built by <strong>Pixel Studio</strong>',
        downloadLabel: 'Download',
        downloadTitle: 'Download software',
        downloadAria: 'Download',
        downloadWindows: 'Download Windows version',
        downloadWeb: 'Web app version',
        downloadWebHelp: 'Web app install guide',
        versionTitle: 'Scale Converter App',
        versionLabel: 'Version',
        versionChangesLabel: 'Latest changes',
        versionChanges: 'UI refinements for a better portrait mobile layout',
        versionHint: 'Follow Pixel Studio for app updates and new software projects.',
        footnote: 'Tip: When scaling geometry in CAD use <span class="mono ltr">scale factor = 1 / N</span> (for <span class="mono ltr">1:200</span> the factor is <span class="mono ltr">0.005</span>). This tool converts units using the same ratio.',
        histDialogLabel: 'History (last 10 values)',
        histTitle: 'History (last 10 values)',
        histCloseLabel: 'Close',
        histEmpty: 'Empty',
        copyPrompt: 'Calculate a value first',
        copySuccess: 'Copied!',
        copyFail: 'Copy failed',
        unitsLabel: (unit) => `Unit: ${unit}`,
        detailIdle: (from, to, n) => `1 ${from} → ? ${to} at 1:${n}`,
        detailForward: (rU, tU, ratio, nLabel) => `1 ${rU} = ${ratio} ${tU}  (scale 1:${nLabel})`,
        detailReverse: (tU, rU, ratio, nLabel) => `1 ${tU} = ${ratio} ${rU}  (scale 1:${nLabel})`,
        historyInfo: (rvStr, scaleStr) => `Real size: ${rvStr} | Scale ${scaleStr}`,
        scaleLabel: (nLabel) => `1:${nLabel}`,
        scaleUnknown: '1:N',
        inputLabelNormal: 'Real size (numbers only)',
        outputLabelNormal: 'Map size (calculated)',
        inputLabelReverse: 'Map size (input)',
        outputLabelReverse: 'Real size (calculated)',
        versionBtnTitle: 'Version details',
        realValuePlaceholder: 'e.g., 12.5',
        realValueAria: 'Real-world size',
        realUnitAria: 'Real-world unit',
        targetUnitAria: 'Map unit',
        scaleSelectAria: 'Choose scale',
        scaleNAria: 'Scale N value',
        formAriaLabel: 'Scale converter form'
      }
    };

    const unitOptionTexts = {
      mm: { fa: 'میلی‌متر (mm)', en: 'Millimetre (mm)' },
      cm: { fa: 'سانتی‌متر (cm)', en: 'Centimetre (cm)' },
      m: { fa: 'متر (m)', en: 'Metre (m)' },
      km: { fa: 'کیلومتر (km)', en: 'Kilometre (km)' },
      in: { fa: 'اینچ (in)', en: 'Inch (in)' },
      ft: { fa: 'فوت (ft)', en: 'Foot (ft)' },
      yd: { fa: 'یارد (yd)', en: 'Yard (yd)' },
      mi: { fa: 'مایل (mi)', en: 'Mile (mi)' },
      nmi: { fa: 'مایل دریایی (nmi)', en: 'Nautical mile (nmi)' }
    };

    const scaleOptionTexts = {
      1: { fa: '۱:۱', en: '1:1' },
      2: { fa: '۱:۲', en: '1:2' },
      5: { fa: '۱:۵', en: '1:5' },
      10: { fa: '۱:۱۰', en: '1:10' },
      20: { fa: '۱:۲۰', en: '1:20' },
      25: { fa: '۱:۲۵', en: '1:25' },
      50: { fa: '۱:۵۰', en: '1:50' },
      75: { fa: '۱:۷۵', en: '1:75' },
      100: { fa: '۱:۱۰۰', en: '1:100' },
      125: { fa: '۱:۱۲۵', en: '1:125' },
      150: { fa: '۱:۱۵۰', en: '1:150' },
      200: { fa: '۱:۲۰۰', en: '1:200' },
      250: { fa: '۱:۲۵۰', en: '1:250' },
      400: { fa: '۱:۴۰۰', en: '1:400' },
      500: { fa: '۱:۵۰۰', en: '1:500' },
      1000: { fa: '۱:۱۰۰۰', en: '1:1000' },
      2000: { fa: '۱:۲۰۰۰', en: '1:2000' },
      5000: { fa: '۱:۵۰۰۰', en: '1:5000' }
    };

    const scaleGroupLabels = {
      scaleGroupDetail: { fa: 'جزئیات (Detail)', en: 'Detail' },
      scaleGroupPlans: { fa: 'نقشه‌های معماری (Plans)', en: 'Architectural plans' },
      scaleGroupSite: { fa: 'سایت/شهر (Site/Urban)', en: 'Site / urban' }
    };

    let currentLang = 'fa';
    try {
      const storedLang = localStorage.getItem('lang');
      if (storedLang && locales[storedLang]) currentLang = storedLang;
    } catch(e) {
      currentLang = 'fa';
    }

    // sync all version labels from one source
    if (versionBtn) versionBtn.textContent = 'v' + APP_VERSION;
    if (versionText) versionText.textContent = APP_VERSION;
    let lastSavedOut = '';
    let reverseMode = false;

    function fmt(n){ if (Number.isNaN(n)) return '—'; return n.toFixed(6).replace(/\.0+$/,'').replace(/(\.[0-9]*?)0+$/, '$1'); }

    function getLocale(){ return locales[currentLang] || locales.fa; }

    function applyUnitOptions(lang){
      const targetLang = locales[lang] ? lang : 'fa';
      Object.keys(unitOptionTexts).forEach((key) => {
        const optionText = unitOptionTexts[key][targetLang] || unitOptionTexts[key].fa;
        const optReal = realUnit ? realUnit.querySelector(`option[value="${key}"]`) : null;
        const optTarget = targetUnit ? targetUnit.querySelector(`option[value="${key}"]`) : null;
        if (optReal) optReal.textContent = optionText;
        if (optTarget) optTarget.textContent = optionText;
      });
    }

    function applyScaleOptions(lang){
      const targetLang = locales[lang] ? lang : 'fa';
      if (scaleSelect){
        scaleSelect.querySelectorAll('option').forEach((opt) => {
          const value = opt.value;
          if (scaleOptionTexts[value]) opt.textContent = scaleOptionTexts[value][targetLang] || scaleOptionTexts[value].fa;
        });
        scaleSelect.querySelectorAll('optgroup').forEach((group) => {
          const key = group.dataset.i18nGroup;
          if (key && scaleGroupLabels[key]) group.label = scaleGroupLabels[key][targetLang] || scaleGroupLabels[key].fa;
        });
      }
    }

    function refreshDetailText(){
      if (!detail) return;
      const locale = getLocale();
      const manual = manualToggle && manualToggle.checked;
      const N = manual ? parseFloat(scaleN.value) : parseFloat(scaleSelect.value);
      const rU = realUnit.value;
      const tU = targetUnit.value;
      const nLabel = (N && N > 0) ? fmt(N) : (manual ? 'N' : (scaleSelect.value || 'N'));
      if (!outVal.textContent || outVal.textContent === '—'){
        detail.textContent = reverseMode ? locale.detailIdle(tU, rU, nLabel) : locale.detailIdle(rU, tU, nLabel);
        return;
      }
      if (!N || N <= 0){
        detail.textContent = reverseMode ? locale.detailIdle(tU, rU, nLabel) : locale.detailIdle(rU, tU, nLabel);
        return;
      }
      if (reverseMode){
        const ratio = fmt((unitToMM[tU] * N) / unitToMM[rU]);
        detail.textContent = locale.detailReverse(tU, rU, ratio, fmt(N));
      } else {
        const ratio = fmt((unitToMM[rU] / N) / unitToMM[tU]);
        detail.textContent = locale.detailForward(rU, tU, ratio, fmt(N));
      }
    }

    function updateHints(){
      const locale = getLocale();
      if (reverseMode){
        realHint.textContent = locale.unitsLabel(targetUnit.value);
        outUnit.textContent = locale.unitsLabel(realUnit.value);
      } else {
        realHint.textContent = locale.unitsLabel(realUnit.value);
        outUnit.textContent = locale.unitsLabel(targetUnit.value);
      }
    }

    function applyLanguage(lang){
      const locale = locales[lang] ? locales[lang] : locales.fa;
      currentLang = locale.code;
      document.documentElement.lang = locale.htmlLang || 'fa';
      document.documentElement.dir = locale.dir || 'rtl';
      document.body.classList.toggle('lang-en', locale.code === 'en');
      document.body.classList.toggle('lang-fa', locale.code !== 'en');
      if (document.title !== locale.pageTitle) document.title = locale.pageTitle;
      if (pageHeading) pageHeading.textContent = locale.heading;
      if (descriptionEl){
        descriptionEl.innerHTML = locale.description;
        descriptionEl.classList.toggle('ltr', locale.code === 'en');
      }
      if (realUnitLabel) realUnitLabel.textContent = locale.realUnitLabel;
      if (scaleSelectLabel) scaleSelectLabel.textContent = locale.scaleSelectLabel;
      if (targetUnitLabel) targetUnitLabel.textContent = locale.targetUnitLabel;
      if (manualHint) manualHint.textContent = locale.manualHint;
      if (calcBtn){
        calcBtn.textContent = locale.calcButton;
        calcBtn.title = locale.calcButtonTitle;
        calcBtn.setAttribute('title', locale.calcButtonTitle);
      }
      if (copyBtn){
        copyBtn.textContent = locale.copyButton;
        copyBtn.title = locale.copyButtonTitle;
        copyBtn.setAttribute('title', locale.copyButtonTitle);
      }
      if (histBtn) histBtn.setAttribute('title', locale.histButtonTitle);
      if (swapBtn) swapBtn.setAttribute('title', locale.swapButtonTitle);
      if (detailHeading) detailHeading.textContent = locale.detailHeading;
      if (footerCredit) footerCredit.innerHTML = locale.footerCredit;
      if (downloadLabel) downloadLabel.textContent = locale.downloadLabel;
      if (downloadWindows) downloadWindows.textContent = locale.downloadWindows;
      if (downloadWeb) downloadWeb.textContent = locale.downloadWeb;
      if (downloadWebHelp) downloadWebHelp.textContent = locale.downloadWebHelp;
      if (dlBtn) dlBtn.setAttribute('title', locale.downloadTitle);
      if (dlPop) dlPop.setAttribute('aria-label', locale.downloadAria);
      if (converterForm) converterForm.setAttribute('aria-label', locale.formAriaLabel);
      const isEnglish = locale.code === 'en';
      if (versionTitle){
        versionTitle.textContent = locale.versionTitle;
        versionTitle.classList.toggle('ltr', isEnglish);
      }
      if (versionLabel){
        versionLabel.textContent = locale.versionLabel;
        const labelRow = versionLabel.parentElement;
        if (labelRow) labelRow.classList.toggle('ltr', isEnglish);
      }
      if (versionChangesLabel){
        versionChangesLabel.textContent = locale.versionChangesLabel;
        versionChangesLabel.classList.toggle('ltr', isEnglish);
      }
      if (versionChanges){
        versionChanges.textContent = locale.versionChanges;
        versionChanges.classList.toggle('ltr', isEnglish);
      }
      if (versionHint){
        versionHint.textContent = locale.versionHint;
        versionHint.classList.toggle('ltr', isEnglish);
      }
      if (verPop) verPop.classList.toggle('ltr', isEnglish);
      if (versionBtn) versionBtn.setAttribute('title', locale.versionBtnTitle);
      if (verPop) verPop.setAttribute('aria-label', locale.versionBtnTitle);
      if (footnote){
        footnote.innerHTML = locale.footnote;
        footnote.classList.toggle('ltr', isEnglish);
      }
      if (histPop) histPop.setAttribute('aria-label', locale.histDialogLabel);
      if (histHead) histHead.textContent = locale.histTitle;
      if (histClose) histClose.setAttribute('aria-label', locale.histCloseLabel);
      if (langToggle){
        langToggle.setAttribute('aria-label', locale.langToggleLabel);
        langToggle.dataset.lang = locale.code;
      }
      if (langToggleText){
        const nextLang = locale.code === 'fa' ? 'en' : 'fa';
        const nextLocale = locales[nextLang] || locales.fa;
        langToggleText.textContent = nextLocale.langButton;
      }
      if (themeToggle) themeToggle.setAttribute('aria-label', locale.themeToggleLabel);
      if (realValue){
        realValue.placeholder = locale.realValuePlaceholder;
        realValue.setAttribute('aria-label', locale.realValueAria);
      }
      if (realUnit) realUnit.setAttribute('aria-label', locale.realUnitAria);
      if (targetUnit) targetUnit.setAttribute('aria-label', locale.targetUnitAria);
      if (scaleSelect) scaleSelect.setAttribute('aria-label', locale.scaleSelectAria);
      if (scaleN) scaleN.setAttribute('aria-label', locale.scaleNAria);
      applyUnitOptions(currentLang);
      applyScaleOptions(currentLang);
      if (copyNote) copyNote.textContent = '';
      applyModeUI();
      updateHints();
      refreshDetailText();
      renderHistory();
    }

    function applyTheme(theme){
      if (theme === 'light') document.body.classList.add('light');
      else document.body.classList.remove('light');
      if (themeToggle){ const isLight = document.body.classList.contains('light'); themeToggle.setAttribute('data-mode', isLight ? 'light' : 'dark'); }
    }

    function initTheme(){
      let theme = localStorage.getItem('theme');
      if (!theme){ try { theme = (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) ? 'light' : 'dark'; } catch(e){ theme = 'dark'; } }
      applyTheme(theme);
    }

    function setManualUI(){ const manual = manualToggle && manualToggle.checked; scaleN.disabled = !manual; scaleSelect.disabled = manual; if (scaleSwap) scaleSwap.classList.toggle('manual', manual); }

    function calcDrawing(rv, rU, N, tU){ const realMM = rv * unitToMM[rU]; const drawingMM = realMM / N; return drawingMM / unitToMM[tU]; }

    function normalizeNumber(str){
      if (!str) return '';
      var s = String(str);
      var fa = '۰۱۲۳۴۵۶۷۸۹';
      var ar = '٠١٢٣٤٥٦٧٨٩';
      s = s.replace(/[۰-۹]/g, d => String(fa.indexOf(d)))
           .replace(/[٠-٩]/g, d => String(ar.indexOf(d)));
      s = s.replace(/[٬,\s\u00A0]/g, ''); // remove thousands (Arabic comma, comma), spaces, NBSP
      s = s.replace(/[٫،]/g, '.'); // Arabic/Persian decimal marks → dot
      s = s.replace(/[^0-9.+-]/g, '');
      return s;
    }

    function compute(){
      const rv = parseFloat(normalizeNumber(realValue.value));
      const manual = manualToggle && manualToggle.checked;
      const N = manual ? parseFloat(scaleN.value) : parseFloat(scaleSelect.value);
      const rU = realUnit.value; const tU = targetUnit.value;
      const locale = getLocale();
      updateHints();
      if (!rv || rv < 0 || !N || N <= 0){ const nLabel = (N && N > 0) ? fmt(N) : (manual ? 'N' : (scaleSelect.value || 'N')); outVal.textContent = '—'; detail.textContent = reverseMode ? locale.detailIdle(tU, rU, nLabel) : locale.detailIdle(rU, tU, nLabel); return; }
      if (reverseMode){
        // input is drawing value; compute real value
        const realVal = (rv * unitToMM[tU] * N) / unitToMM[rU];
        outVal.textContent = `${fmt(realVal)} ${rU}`; addToHistory(outVal.textContent,{rv, rU, tU, N, reverse:true});
        const oneTargetToReal = (unitToMM[tU] * N) / unitToMM[rU];
        detail.textContent = locale.detailReverse(tU, rU, fmt(oneTargetToReal), fmt(N));
      } else {
        // normal: input is real value; compute drawing value
        const drawingVal = calcDrawing(rv, rU, N, tU);
        outVal.textContent = `${fmt(drawingVal)} ${tU}`; addToHistory(outVal.textContent,{rv, rU, tU, N, reverse:false});
        const oneRealToTarget = (unitToMM[rU] / N) / unitToMM[tU];
        detail.textContent = locale.detailForward(rU, tU, fmt(oneRealToTarget), fmt(N));
      }
    }

    function clearOutput(){
      const manual = manualToggle && manualToggle.checked;
      const N = manual ? parseFloat(scaleN.value) : parseFloat(scaleSelect.value);
      const rU = realUnit.value; const tU = targetUnit.value;
      outVal.textContent = '—';
      const locale = getLocale();
      const nLabel = (N && N > 0) ? fmt(N) : (manual ? 'N' : (scaleSelect.value || 'N'));
      detail.textContent = reverseMode ? locale.detailIdle(tU, rU, nLabel) : locale.detailIdle(rU, tU, nLabel);
    }

    realUnit.addEventListener('change', ()=>{ updateHints(); clearOutput(); });
    targetUnit.addEventListener('change', ()=>{ updateHints(); clearOutput(); });
    scaleSelect.addEventListener('change', ()=>{ clearOutput(); });
    manualToggle.addEventListener('change', ()=>{ setManualUI(); updateHints(); clearOutput(); });
    scaleN.addEventListener('input', clearOutput);
    realValue.addEventListener('input', clearOutput);
    // Pressing Enter in the real value input triggers calculation
    realValue.addEventListener('keydown', function(e){
      if (e.key === 'Enter' || e.key === 'NumpadEnter'){
        e.preventDefault();
        compute();
      }
    });
    if (calcBtn) calcBtn.addEventListener('click', compute);
    if (themeToggle) themeToggle.addEventListener('click', function(){ const isLight = !document.body.classList.contains('light'); applyTheme(isLight ? 'light' : 'dark'); localStorage.setItem('theme', isLight ? 'light' : 'dark'); });
    if (langToggle) langToggle.addEventListener('click', function(){ const next = currentLang === 'fa' ? 'en' : 'fa'; applyLanguage(next); try { localStorage.setItem('lang', next); } catch(e){} });

    copyBtn.addEventListener('click', async () => {
      const raw = outVal.textContent || ''; let val = raw.trim();
      const locale = getLocale();
      if (!val || val === '—') { copyNote.textContent = locale.copyPrompt; setTimeout(()=>{ copyNote.textContent=''; }, 1500); return; }
      const units = ['mm','cm','m','km','in','ft','yd','mi','nmi']; for (let i=0;i<units.length;i++){ const u=units[i]; if (val.endsWith(' '+u)) { val = val.slice(0, -(u.length+1)); break; } }
      let ok = false; if (navigator.clipboard && window.isSecureContext) { try { await navigator.clipboard.writeText(val); ok = true; } catch(e) { ok = false; } }
      if (!ok) { try { const ta=document.createElement('textarea'); ta.value=val; ta.style.position='fixed'; ta.style.left='-1000px'; ta.style.top='-1000px'; ta.style.opacity='0'; document.body.appendChild(ta); ta.focus(); ta.select(); try { ta.setSelectionRange(0, ta.value.length); } catch(e){} ok = document.execCommand('copy'); document.body.removeChild(ta); } catch(e) { ok=false; } }
      copyNote.textContent = ok ? locale.copySuccess : locale.copyFail; setTimeout(()=>{ copyNote.textContent=''; }, 1500);
    });

    // ---- History helpers ----
    function readHistory(){ try { return JSON.parse(localStorage.getItem('hist')||'[]'); } catch(e){ return []; } }
    function writeHistory(arr){ try { localStorage.setItem('hist', JSON.stringify(arr.slice(0,10))); } catch(e){} }
    function renderHistory(){
      if (!histList) return;
      const arr = readHistory();
      const locale = getLocale();
      if (!arr.length){ histList.innerHTML = `<li class="hist-empty">${locale.histEmpty}</li>`; return; }
      histList.innerHTML = arr.map(i => {
        const m = i.meta || {};
        const rvStr = m && m.reverse ? i.out : `${fmt(m.rv)} ${m.rU || ''}`;
        const scaleStr = (m && typeof m.N !== 'undefined' && !Number.isNaN(m.N)) ? locale.scaleLabel(fmt(m.N)) : locale.scaleUnknown;
        const outStr = i.out; // already includes unit
        const info = locale.historyInfo(rvStr, scaleStr);
        return `<li class="hist-li"><div class="mono">${outStr}</div><div class="hint">${info}</div></li>`;
      }).join('');
    }
    function addToHistory(outText, meta){ if (!outText || outText==='—') return; const arr = readHistory(); if (arr.length && arr[0].out === outText) return; arr.unshift({out: outText, meta: meta||null, t: Date.now()}); writeHistory(arr); if (histPop && !histPop.classList.contains('hidden')) renderHistory(); lastSavedOut = outText; }
    function closeOthers(except){ if (except!=='history') toggleHistory(false); if (except!=='version') toggleVersion(false); if (except!=='download') toggleDownload(false); }
    function toggleHistory(show){ if (!histPop) return; const open = !histPop.classList.contains('hidden'); const willOpen = (typeof show==='boolean') ? show : !open; if (willOpen){ closeOthers('history'); histPop.classList.remove('hidden'); renderHistory(); } else { histPop.classList.add('hidden'); } }
    if (histBtn){ histBtn.addEventListener('click', function(e){ e.stopPropagation(); toggleHistory(); }); }
    if (histClose){ histClose.addEventListener('click', function(e){ e.stopPropagation(); toggleHistory(false); }); }
    function toggleVersion(show){ if (!verPop || !versionBtn) return; const open = !verPop.classList.contains('hidden'); const willOpen = (typeof show==='boolean') ? show : !open; if (willOpen){ closeOthers('version'); verPop.classList.remove('hidden'); versionBtn.setAttribute('aria-expanded','true'); } else { verPop.classList.add('hidden'); versionBtn.setAttribute('aria-expanded','false'); } }
    if (versionBtn){ versionBtn.addEventListener('click', function(e){ e.stopPropagation(); toggleVersion(); }); }
    function toggleDownload(show){ if (!dlPop || !dlBtn) return; const open = !dlPop.classList.contains('hidden'); const willOpen = (typeof show==='boolean') ? show : !open; if (willOpen){ closeOthers('download'); dlPop.classList.remove('hidden'); dlBtn.setAttribute('aria-expanded','true'); } else { dlPop.classList.add('hidden'); dlBtn.setAttribute('aria-expanded','false'); } }
    if (dlBtn){ dlBtn.addEventListener('click', function(e){ e.stopPropagation(); toggleDownload(); }); }

    // FIX: remove stray "$1" and properly handle outside-click to close popovers
    document.addEventListener('click', function(e){
      // Close download popover if click is outside
      if (dlPop && !dlPop.classList.contains('hidden')){
        if (!(dlPop.contains(e.target) || (dlBtn && dlBtn.contains(e.target)))) toggleDownload(false);
      }
      // Close history popover if click is outside
      if (histPop && !histPop.classList.contains('hidden')){
        if (!(histPop.contains(e.target) || (histBtn && histBtn.contains(e.target)))) toggleHistory(false);
      }
      // Close version popover if click is outside
      if (verPop && !verPop.classList.contains('hidden')){
        if (!(verPop.contains(e.target) || (versionBtn && versionBtn.contains(e.target)))) toggleVersion(false);
      }
    });

    document.addEventListener('keydown', function(e){ if (e.key === 'Escape'){ toggleHistory(false); toggleVersion(false); toggleDownload(false); } });

    function applyModeUI(){
      if (!inputLabel || !outputLabel) return;
      const locale = getLocale();
      if (reverseMode){
        inputLabel.textContent = locale.inputLabelReverse;
        outputLabel.textContent = locale.outputLabelReverse;
      } else {
        inputLabel.textContent = locale.inputLabelNormal;
        outputLabel.textContent = locale.outputLabelNormal;
      }
    }

    if (swapBtn){ swapBtn.addEventListener('click', function(){ reverseMode = !reverseMode; try { localStorage.setItem('reverseMode', reverseMode ? '1' : '0'); } catch(e){} this.setAttribute('aria-pressed', reverseMode ? 'true' : 'false'); applyModeUI(); updateHints(); clearOutput(); }); }

    // ===== Initialize =====
    initTheme();
    try { reverseMode = localStorage.getItem('reverseMode') === '1'; } catch(e) { reverseMode = false; }
    if (swapBtn) swapBtn.setAttribute('aria-pressed', reverseMode ? 'true' : 'false');

    // Per request: always start with an empty history on each open
    try { localStorage.removeItem('hist'); } catch(e) {}

    applyLanguage(currentLang);
    setManualUI();
    updateHints();
    clearOutput();

    // ===== Console self-tests (compact) =====
    (function(){
      const near=(a,b,eps=1e-9)=>Math.abs(a-b)<eps;
      const pass=[
        ['Persian digits', normalizeNumber('۱۲۳٫۴۵')==='123.45'],
        ['2 m @1:200 → 10 mm', near(calcDrawing(2,'m',200,'mm'),10)],
        ['reverse 0.5 cm @1:200 → 1 m', near((0.5*unitToMM.cm*200)/unitToMM.m,1)],
        ['round-trip 2m', near((calcDrawing(2,'m',200,'mm')*unitToMM.mm*200)/unitToMM.m,2)]
      ].filter(x=>x[1]).length;
      console.log('[Test]', pass+'/4 passed');
    })();
  </script>
</body>
</html>
